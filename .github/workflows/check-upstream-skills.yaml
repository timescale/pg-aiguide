name: Check Upstream Skills

on:
  # Run weekly on Monday at 9am UTC
  schedule:
    - cron: '0 9 * * 1'
  # Allow manual trigger
  workflow_dispatch:

jobs:
  check-upstream:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v5
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Check upstream skills for updates
        id: check
        run: npm run check:upstream-skills
        continue-on-error: true

      - name: Create or update issue if upstream changed
        if: steps.check.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Upstream skill files have changed';
            const body = `The upstream skill check has detected changes in one or more skill files.

            Please review the upstream changes and update the local skill files if needed.

            **Latest workflow run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}

            **After updating:**
            1. Review the changes in the upstream repository
            2. Update the local SKILL.md file with any relevant changes
            3. Update the \`pinned_commit\` in UPSTREAM.json to the new commit hash
            `;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'upstream-sync'
            });

            const existingIssue = issues.data.find(issue => issue.title === title);

            if (existingIssue) {
              // Update existing issue with latest run info
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `Upstream changes still detected. Latest workflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const newIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['upstream-sync']
              });
              console.log(`Created new issue #${newIssue.data.number}`);
            }

      - name: Fail if upstream changed
        if: steps.check.outcome == 'failure'
        run: exit 1
