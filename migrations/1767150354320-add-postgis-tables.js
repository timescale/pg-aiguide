import 'dotenv/config';
import { Client } from 'pg';

const schema = process.env.DB_SCHEMA || 'docs';

export const description = 'Add PostGIS documentation tables';

export async function up() {
  const client = new Client();

  try {
    await client.connect();
    await client.query('BEGIN');
    await client.query(/* sql */ `
      -- PostGIS documentation pages table
      CREATE TABLE IF NOT EXISTS ${schema}.postgis_pages (
        id int4 PRIMARY KEY generated by default as identity
        , version TEXT NOT NULL
        , url TEXT UNIQUE NOT NULL
        , domain TEXT NOT NULL
        , filename TEXT NOT NULL
        , content_length INTEGER
        , scraped_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        , chunking_method TEXT DEFAULT 'header'
        , chunks_count INTEGER DEFAULT 0
      );

      -- PostGIS documentation chunks table with vector embeddings
      CREATE TABLE IF NOT EXISTS ${schema}.postgis_chunks (
        id int4 PRIMARY KEY generated by default as identity
        , page_id INTEGER REFERENCES ${schema}.postgis_pages(id) ON DELETE CASCADE
        , chunk_index INTEGER NOT NULL
        , sub_chunk_index INTEGER NOT NULL DEFAULT 0
        , content TEXT NOT NULL
        , metadata JSONB
        , embedding vector(1536)
        , created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      );

      -- Create HNSW index for fast vector similarity search
      CREATE INDEX IF NOT EXISTS postgis_chunks_embedding_idx
        ON ${schema}.postgis_chunks
        USING hnsw (embedding vector_cosine_ops);

      -- Create index on page_id for efficient joins
      CREATE INDEX IF NOT EXISTS postgis_chunks_page_id_idx
        ON ${schema}.postgis_chunks (page_id);

      -- Create index on version for filtering by PostGIS version
      CREATE INDEX IF NOT EXISTS postgis_pages_version_idx
        ON ${schema}.postgis_pages (version);
    `);

    await client.query('COMMIT');
  } catch (e) {
    await client.query('ROLLBACK');
    throw e;
  } finally {
    await client.end();
  }
}

export async function down() {
  const client = new Client();

  try {
    await client.connect();
    await client.query(/* sql */ `
      DROP TABLE IF EXISTS ${schema}.postgis_chunks;
      DROP TABLE IF EXISTS ${schema}.postgis_pages;
    `);
  } finally {
    await client.end();
  }
}
